<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Card Slot Clicker 1to9</title>
<style>
/* ---------- 既存のスタイル省略 ---------- */
/* toastスタイルを少し改良 */
.toast{
  position:fixed;right:18px;top:18px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;
  opacity:0.98; box-shadow:0 8px 30px rgba(0,0,0,0.25); display:flex;align-items:center;justify-content:space-between;
  min-width:180px;
}
.toast span.countdown{ margin-left:8px; font-size:12px; color:#aaa; }
</style>
</head>
<body>
<div class="container">
  <!-- 左右のコンテナ省略、既存コードそのまま -->
</div>

<!-- toast holder -->
<div id="toastHolder" style="position:fixed;right:18px;top:18px;z-index:1200"></div>

<script>
// ---------- ユーティリティ ----------
function $(id){ return document.getElementById(id); }
function randInt(n){ return Math.floor(Math.random()*n); }

// ---------- toast改良版 ----------
function showToast(text, duration=3000){
  const d = document.createElement('div');
  d.className='toast';
  d.innerHTML = `${text} <span class="countdown">${Math.ceil(duration/1000)}</span>s`;
  $('toastHolder').appendChild(d);

  let remaining = duration/1000;
  const interval = setInterval(()=>{
    remaining--;
    d.querySelector('.countdown').textContent = remaining + 's';
  },1000);

  setTimeout(()=>{
    clearInterval(interval);
    d.remove();
  }, duration);
}

// ---------- ゲームステート ----------
let coin = 100, mana=0, xp=0, level=1, skillPoint=0;
let clickPower=1, autoPower=0;
let hand=[], deck=[], discard=[];
let spinning=[false,false,false];
let spinIntervals=[null,null,null];
let luck=50;
let activeEvent=null, eventTimer=null;
let insuranceActive=false, doubleActive=false, superspinActiveCount=0;

// ---------- スキル定義省略 ----------
// ---------- カード定義省略 ----------

// ---------- デッキ / 手札 ----------
function initDeck(){ /* 既存コード */ }
function shuffle(a){ /* 既存コード */ }
function drawCard(){ /* 既存コード */ }
function renderHand(){ /* 既存コード */ }
function playCard(idx){ 
  const c = hand[idx]; if(!c) return;
  if(mana < c.cost){ showToast('マナ不足'); return; }
  mana -= c.cost; updateUI();
  discard.push(c); hand.splice(idx,1); renderHand();
  applyCardEffect(c);
}

// ---------- カード効果 ----------
function applyCardEffect(card){
  switch(card.type){
    case 'reroll': showReelChooser(); break;
    case 'double': doubleActive=true; showToast('ダブル発動！次スロット配当2倍'); break;
    case 'draw': drawCard(); break;
    case 'insurance': insuranceActive=true; showToast('保険有効：次の負けで-20補填'); break;
    case 'superspin': superspinActiveCount=Math.max(superspinActiveCount,1); showToast('スーパー・スピン：次スピンが有利'); break;
    case 'manarecover': mana+=2; updateUI(); break;
    case 'coinplus': coin+=5; updateUI(); break;
  }
}

// ---------- リール選択 ----------
function showReelChooser(){
  const holder = document.createElement('div');
  holder.style.position='absolute'; holder.style.left='50%'; holder.style.top='50%';
  holder.style.transform='translate(-50%,-50%)'; holder.style.zIndex=9999;
  const b0=document.createElement('button'); b0.textContent='左リール再スピン'; b0.onclick=()=>{ rerollReel(0); holder.remove(); };
  const b1=document.createElement('button'); b1.textContent='中リール再スピン'; b1.onclick=()=>{ rerollReel(1); holder.remove(); };
  const b2=document.createElement('button'); b2.textContent='右リール再スピン'; b2.onclick=()=>{ rerollReel(2); holder.remove(); };
  [b0,b1,b2].forEach(b=>{ b.style.margin='6px'; b.style.padding='8px'; });
  holder.appendChild(b0); holder.appendChild(b1); holder.appendChild(b2);
  document.body.appendChild(holder);
}

// ---------- スピン ----------
let spinLock=false;
const spinState={ forceWin:false };

function spin(){
  if(spinLock) return;
  const bet = 20;
  if(coin < bet){ showToast('コイン不足'); return; }
  coin -= bet; updateUI();

  // スーパースピンで揃いやすさ増加
  let baseForce = 0.05 + (luck/100)*0.2;
  if(superspinActiveCount>0) baseForce += 0.2; superspinActiveCount--;

  spinLock=true;
  for(let r=0;r<3;r++){
    spinning[r]=true;
    $(`stop${r}`).disabled=false;
    const cells = [$(`cell${r}`), $(`cell${r+3}`), $(`cell${r+6}`)];
    spinIntervals[r] = setInterval(()=>{
      cells.forEach(cell=>{
        const img=document.createElement('img'); img.src=`images/slot${randInt(9)+1}.png`;
        cell.innerHTML=''; cell.appendChild(img);
      });
    }, 90 + randInt(60));
  }

  spinState.forceWin = Math.random()<baseForce;

  // ターン開始時にカード効果リセット
  doubleActive=false; insuranceActive=false;
}

// ---------- リール停止 ----------
function stopReel(r){
  if(!spinning[r]) return;
  clearInterval(spinIntervals[r]); spinIntervals[r]=null; spinning[r]=false;
  $(`stop${r}`).disabled=true;
  if(!spinning[0] && !spinning[1] && !spinning[2]) finalizeSpin();
}

// ---------- リロール ----------
function rerollReel(r){
  const cells=[ $(`cell${r}`), $(`cell${r+3}`), $(`cell${r+6}`) ];
  cells.forEach(cell=>{
    const img=document.createElement('img'); img.src = `images/slot${randInt(9)+1}.png`;
    cell.innerHTML=''; cell.appendChild(img);
  });
  finalizeSpin();
}

// ---------- スピン終了処理 ----------
function finalizeSpin(){
  // forceWin適用
  if(spinState.forceWin){
    const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    const chosen = lines[randInt(lines.length)];
    const symbol = `images/slot${randInt(9)+1}.png`;
    chosen.forEach(i=>{ const el=$(`cell${i}`); el.innerHTML=''; const img=document.createElement('img'); img.src=symbol; el.appendChild(img); });
    spinState.forceWin=false;
  }

  // 揃い判定
  const grid=[]; for(let i=0;i<9;i++){ const el=$(`cell${i}`).firstChild; grid.push(el?el.src:null); }
  const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  let hit=false;
  for(let line of lines){ const [a,b,c]=line; if(grid[a] && grid[a]===grid[b] && grid[b]===grid[c]){hit=true; break;} }

  if(hit){
    let payout = 20*(5 + 0); // slot skill簡略化
    if(doubleActive) payout *=2;
    coin += payout; xp+=2;
    showToast(`揃い！ 配当 + ${payout}`);
  } else {
    if(insuranceActive){ coin+=20; showToast('保険発動：ベット返還'); }
  }

  // 終了処理
  luck=Math.max(1, Math.min(100, randInt(100)+1));
  updateLuckColors();
  updateUI();
  $('spinBtn').disabled=false;
  spinLock=false;
}

// ---------- Luck色 ----------
function updateLuckColors(){
  const hue=240 - Math.round((luck/100)*240);
  const color=`hsl(${hue},70%,45%)`;
  for(let i=0;i<9;i++) $(`cell${i}`).style.borderColor=color;
  $('luckView').textContent=luck;
}

// ---------- クリック ----------
$('clickBtn').addEventListener('click',()=>{
  let gain=clickPower; coin+=gain; updateUI();
});

// ---------- 自動クリック ----------
setInterval(()=>{ if(autoPower>0){ coin+=autoPower; updateUI(); } },1000);

// ---------- クリッカーイベント ----------
function triggerClickerEvent(name){
  showToast(`クリッカーイベント発生: ${name}`, 10000);
  activeEvent={name,type:'clicker'};
  if(eventTimer) clearTimeout(eventTimer);
  eventTimer = setTimeout(()=>{ showToast(`クリッカーイベント終了: ${name}`); activeEvent=null; },10000);
}

// ---------- UI更新 ----------
function updateUI(){
  $('coin').textContent=coin;
  $('mana').textContent=mana;
  $('xp').textContent=xp;
  $('level').textContent=level;
}

// ---------- 初期化 ----------
function setup(){
  // 初期スロット画像
  for(let i=0;i<9;i++){ const img=document.createElement('img'); img.src=`images/slot${randInt(9)+1}.png`; $(`cell${i}`).appendChild(img); }
  updateLuckColors(); updateUI();

  $('spinBtn').addEventListener('click', ()=> { if(spinLock) return; spin(); });
  $('stop0').addEventListener('click', ()=> stopReel(0));
  $('stop1').addEventListener('click', ()=> stopReel(1));
  $('stop2').addEventListener('click', ()=> stopReel(2));
}

setup();
</script>
</body>
</html>
